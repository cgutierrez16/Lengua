{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CdpTargetManager = void 0;\nconst log_js_1 = require(\"../../../utils/log.js\");\nconst BrowsingContextImpl_js_1 = require(\"../context/BrowsingContextImpl.js\");\nconst WorkerRealm_js_1 = require(\"../script/WorkerRealm.js\");\nconst CdpTarget_js_1 = require(\"./CdpTarget.js\");\nconst cdpToBidiTargetTypes = {\n  service_worker: 'service-worker',\n  shared_worker: 'shared-worker',\n  worker: 'dedicated-worker'\n};\nclass CdpTargetManager {\n  #browserCdpClient;\n  #cdpConnection;\n  #selfTargetId;\n  #eventManager;\n  #browsingContextStorage;\n  #networkStorage;\n  #acceptInsecureCerts;\n  #preloadScriptStorage;\n  #realmStorage;\n  #defaultUserContextId;\n  #logger;\n  constructor(cdpConnection, browserCdpClient, selfTargetId, eventManager, browsingContextStorage, realmStorage, networkStorage, preloadScriptStorage, acceptInsecureCerts, defaultUserContextId, logger) {\n    this.#acceptInsecureCerts = acceptInsecureCerts;\n    this.#cdpConnection = cdpConnection;\n    this.#browserCdpClient = browserCdpClient;\n    this.#selfTargetId = selfTargetId;\n    this.#eventManager = eventManager;\n    this.#browsingContextStorage = browsingContextStorage;\n    this.#preloadScriptStorage = preloadScriptStorage;\n    this.#networkStorage = networkStorage;\n    this.#realmStorage = realmStorage;\n    this.#defaultUserContextId = defaultUserContextId;\n    this.#logger = logger;\n    this.#setEventListeners(browserCdpClient);\n  }\n  /**\n   * This method is called for each CDP session, since this class is responsible\n   * for creating and destroying all targets and browsing contexts.\n   */\n  #setEventListeners(cdpClient) {\n    cdpClient.on('Target.attachedToTarget', params => {\n      this.#handleAttachedToTargetEvent(params, cdpClient);\n    });\n    cdpClient.on('Target.detachedFromTarget', this.#handleDetachedFromTargetEvent.bind(this));\n    cdpClient.on('Target.targetInfoChanged', this.#handleTargetInfoChangedEvent.bind(this));\n    cdpClient.on('Inspector.targetCrashed', () => {\n      this.#handleTargetCrashedEvent(cdpClient);\n    });\n    cdpClient.on('Page.frameAttached', this.#handleFrameAttachedEvent.bind(this));\n    cdpClient.on('Page.frameDetached', this.#handleFrameDetachedEvent.bind(this));\n  }\n  #handleFrameAttachedEvent(params) {\n    const parentBrowsingContext = this.#browsingContextStorage.findContext(params.parentFrameId);\n    if (parentBrowsingContext !== undefined) {\n      BrowsingContextImpl_js_1.BrowsingContextImpl.create(params.frameId, params.parentFrameId, parentBrowsingContext.userContext, parentBrowsingContext.cdpTarget, this.#eventManager, this.#browsingContextStorage, this.#realmStorage, this.#logger);\n    }\n  }\n  #handleFrameDetachedEvent(params) {\n    // In case of OOPiF no need in deleting BrowsingContext.\n    if (params.reason === 'swap') {\n      return;\n    }\n    this.#browsingContextStorage.findContext(params.frameId)?.dispose();\n  }\n  #handleAttachedToTargetEvent(params, parentSessionCdpClient) {\n    const {\n      sessionId,\n      targetInfo\n    } = params;\n    const targetCdpClient = this.#cdpConnection.getCdpClient(sessionId);\n    switch (targetInfo.type) {\n      case 'page':\n      case 'iframe':\n        {\n          if (targetInfo.targetId === this.#selfTargetId) {\n            break;\n          }\n          const cdpTarget = this.#createCdpTarget(targetCdpClient, targetInfo);\n          const maybeContext = this.#browsingContextStorage.findContext(targetInfo.targetId);\n          if (maybeContext) {\n            // OOPiF.\n            maybeContext.updateCdpTarget(cdpTarget);\n          } else {\n            const userContext = targetInfo.browserContextId && targetInfo.browserContextId !== this.#defaultUserContextId ? targetInfo.browserContextId : 'default';\n            // New context.\n            BrowsingContextImpl_js_1.BrowsingContextImpl.create(targetInfo.targetId, null, userContext, cdpTarget, this.#eventManager, this.#browsingContextStorage, this.#realmStorage, this.#logger);\n          }\n          return;\n        }\n      case 'service_worker':\n      case 'worker':\n        {\n          const realm = this.#realmStorage.findRealm({\n            cdpSessionId: parentSessionCdpClient.sessionId\n          });\n          // If there is no browsing context, this worker is already terminated.\n          if (!realm) {\n            break;\n          }\n          const cdpTarget = this.#createCdpTarget(targetCdpClient, targetInfo);\n          this.#handleWorkerTarget(cdpToBidiTargetTypes[targetInfo.type], cdpTarget, realm);\n          return;\n        }\n      // In CDP, we only emit shared workers on the browser and not the set of\n      // frames that use the shared worker. If we change this in the future to\n      // behave like service workers (emits on both browser and frame targets),\n      // we can remove this block and merge service workers with the above one.\n      case 'shared_worker':\n        {\n          const cdpTarget = this.#createCdpTarget(targetCdpClient, targetInfo);\n          this.#handleWorkerTarget(cdpToBidiTargetTypes[targetInfo.type], cdpTarget);\n          return;\n        }\n    }\n    // DevTools or some other not supported by BiDi target. Just release\n    // debugger and ignore them.\n    targetCdpClient.sendCommand('Runtime.runIfWaitingForDebugger').then(() => parentSessionCdpClient.sendCommand('Target.detachFromTarget', params)).catch(error => this.#logger?.(log_js_1.LogType.debugError, error));\n  }\n  #createCdpTarget(targetCdpClient, targetInfo) {\n    this.#setEventListeners(targetCdpClient);\n    const target = CdpTarget_js_1.CdpTarget.create(targetInfo.targetId, targetCdpClient, this.#browserCdpClient, this.#realmStorage, this.#eventManager, this.#preloadScriptStorage, this.#browsingContextStorage, this.#networkStorage, this.#acceptInsecureCerts, this.#logger);\n    this.#networkStorage.onCdpTargetCreated(target);\n    return target;\n  }\n  #workers = new Map();\n  #handleWorkerTarget(realmType, cdpTarget, ownerRealm) {\n    cdpTarget.cdpClient.on('Runtime.executionContextCreated', params => {\n      const {\n        uniqueId,\n        id,\n        origin\n      } = params.context;\n      const workerRealm = new WorkerRealm_js_1.WorkerRealm(cdpTarget.cdpClient, this.#eventManager, id, this.#logger, (0, BrowsingContextImpl_js_1.serializeOrigin)(origin), ownerRealm ? [ownerRealm] : [], uniqueId, this.#realmStorage, realmType);\n      this.#workers.set(cdpTarget.cdpSessionId, workerRealm);\n    });\n  }\n  #handleDetachedFromTargetEvent({\n    sessionId,\n    targetId\n  }) {\n    if (targetId) {\n      this.#preloadScriptStorage.find({\n        targetId\n      }).map(preloadScript => {\n        preloadScript.dispose(targetId);\n      });\n    }\n    const context = this.#browsingContextStorage.findContextBySession(sessionId);\n    if (context) {\n      context.dispose();\n      return;\n    }\n    const worker = this.#workers.get(sessionId);\n    if (worker) {\n      this.#realmStorage.deleteRealms({\n        cdpSessionId: worker.cdpClient.sessionId\n      });\n    }\n  }\n  #handleTargetInfoChangedEvent(params) {\n    const context = this.#browsingContextStorage.findContext(params.targetInfo.targetId);\n    if (context) {\n      context.onTargetInfoChanged(params);\n    }\n  }\n  #handleTargetCrashedEvent(cdpClient) {\n    // This is primarily used for service and shared workers. CDP tends to not\n    // signal they closed gracefully and instead says they crashed to signal\n    // they are closed.\n    const realms = this.#realmStorage.findRealms({\n      cdpSessionId: cdpClient.sessionId\n    });\n    for (const realm of realms) {\n      realm.dispose();\n    }\n  }\n}\nexports.CdpTargetManager = CdpTargetManager;","map":{"version":3,"names":["log_js_1","require","BrowsingContextImpl_js_1","WorkerRealm_js_1","CdpTarget_js_1","cdpToBidiTargetTypes","service_worker","shared_worker","worker","CdpTargetManager","browserCdpClient","cdpConnection","selfTargetId","eventManager","browsingContextStorage","networkStorage","acceptInsecureCerts","preloadScriptStorage","realmStorage","defaultUserContextId","logger","constructor","setEventListeners","#setEventListeners","cdpClient","on","params","handleAttachedToTargetEvent","handleDetachedFromTargetEvent","bind","handleTargetInfoChangedEvent","handleTargetCrashedEvent","handleFrameAttachedEvent","handleFrameDetachedEvent","#handleFrameAttachedEvent","parentBrowsingContext","findContext","parentFrameId","undefined","BrowsingContextImpl","create","frameId","userContext","cdpTarget","#handleFrameDetachedEvent","reason","dispose","#handleAttachedToTargetEvent","parentSessionCdpClient","sessionId","targetInfo","targetCdpClient","getCdpClient","type","targetId","createCdpTarget","maybeContext","updateCdpTarget","browserContextId","realm","findRealm","cdpSessionId","handleWorkerTarget","sendCommand","then","catch","error","LogType","debugError","#createCdpTarget","target","CdpTarget","onCdpTargetCreated","workers","Map","#handleWorkerTarget","realmType","ownerRealm","uniqueId","id","origin","context","workerRealm","WorkerRealm","serializeOrigin","set","#handleDetachedFromTargetEvent","find","map","preloadScript","findContextBySession","get","deleteRealms","#handleTargetInfoChangedEvent","onTargetInfoChanged","#handleTargetCrashedEvent","realms","findRealms","exports"],"sources":["../../../../../src/bidiMapper/modules/cdp/CdpTargetManager.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}