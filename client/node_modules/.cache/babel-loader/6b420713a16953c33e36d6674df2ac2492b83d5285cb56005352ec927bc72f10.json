{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CdpTarget = void 0;\nconst chromium_bidi_js_1 = require(\"../../../protocol/chromium-bidi.js\");\nconst Deferred_js_1 = require(\"../../../utils/Deferred.js\");\nconst LogManager_js_1 = require(\"../log/LogManager.js\");\nclass CdpTarget {\n  #id;\n  #cdpClient;\n  #browserCdpClient;\n  #eventManager;\n  #preloadScriptStorage;\n  #browsingContextStorage;\n  #networkStorage;\n  #unblocked = new Deferred_js_1.Deferred();\n  #acceptInsecureCerts;\n  #networkDomainEnabled = false;\n  #fetchDomainStages = {\n    request: false,\n    response: false,\n    auth: false\n  };\n  static create(targetId, cdpClient, browserCdpClient, realmStorage, eventManager, preloadScriptStorage, browsingContextStorage, networkStorage, acceptInsecureCerts, logger) {\n    const cdpTarget = new CdpTarget(targetId, cdpClient, browserCdpClient, eventManager, preloadScriptStorage, browsingContextStorage, networkStorage, acceptInsecureCerts);\n    LogManager_js_1.LogManager.create(cdpTarget, realmStorage, eventManager, logger);\n    cdpTarget.#setEventListeners();\n    // No need to await.\n    // Deferred will be resolved when the target is unblocked.\n    void cdpTarget.#unblock();\n    return cdpTarget;\n  }\n  constructor(targetId, cdpClient, browserCdpClient, eventManager, preloadScriptStorage, browsingContextStorage, networkStorage, acceptInsecureCerts) {\n    this.#id = targetId;\n    this.#cdpClient = cdpClient;\n    this.#browserCdpClient = browserCdpClient;\n    this.#eventManager = eventManager;\n    this.#preloadScriptStorage = preloadScriptStorage;\n    this.#networkStorage = networkStorage;\n    this.#browsingContextStorage = browsingContextStorage;\n    this.#acceptInsecureCerts = acceptInsecureCerts;\n  }\n  /** Returns a deferred that resolves when the target is unblocked. */\n  get unblocked() {\n    return this.#unblocked;\n  }\n  get id() {\n    return this.#id;\n  }\n  get cdpClient() {\n    return this.#cdpClient;\n  }\n  get browserCdpClient() {\n    return this.#browserCdpClient;\n  }\n  /** Needed for CDP escape path. */\n  get cdpSessionId() {\n    // SAFETY we got the client by it's id for creating\n    return this.#cdpClient.sessionId;\n  }\n  /**\n   * Enables all the required CDP domains and unblocks the target.\n   */\n  async #unblock() {\n    try {\n      await Promise.all([this.#cdpClient.sendCommand('Runtime.enable'), this.#cdpClient.sendCommand('Page.enable'), this.#cdpClient.sendCommand('Page.setLifecycleEventsEnabled', {\n        enabled: true\n      }),\n      // Set ignore certificate errors for each target.\n      this.#cdpClient.sendCommand('Security.setIgnoreCertificateErrors', {\n        ignore: this.#acceptInsecureCerts\n      }), this.toggleNetworkIfNeeded(), this.#cdpClient.sendCommand('Target.setAutoAttach', {\n        autoAttach: true,\n        waitForDebuggerOnStart: true,\n        flatten: true\n      }), this.#initAndEvaluatePreloadScripts(), this.#cdpClient.sendCommand('Runtime.runIfWaitingForDebugger')]);\n    } catch (error) {\n      // The target might have been closed before the initialization finished.\n      if (!this.#cdpClient.isCloseError(error)) {\n        this.#unblocked.resolve({\n          kind: 'error',\n          error\n        });\n        return;\n      }\n    }\n    this.#unblocked.resolve({\n      kind: 'success',\n      value: undefined\n    });\n  }\n  async toggleFetchIfNeeded() {\n    const stages = this.#networkStorage.getInterceptionStages(this.topLevelId);\n    if (\n    // Only toggle interception when Network is enabled\n    !this.#networkDomainEnabled || this.#fetchDomainStages.request === stages.request && this.#fetchDomainStages.response === stages.response && this.#fetchDomainStages.auth === stages.auth) {\n      return;\n    }\n    const patterns = [];\n    this.#fetchDomainStages = stages;\n    if (stages.request || stages.auth) {\n      // CDP quirk we need request interception when we intercept auth\n      patterns.push({\n        urlPattern: '*',\n        requestStage: 'Request'\n      });\n    }\n    if (stages.response) {\n      patterns.push({\n        urlPattern: '*',\n        requestStage: 'Response'\n      });\n    }\n    if (patterns.length) {\n      await this.#cdpClient.sendCommand('Fetch.enable', {\n        patterns,\n        handleAuthRequests: stages.auth\n      });\n    } else {\n      await this.#cdpClient.sendCommand('Fetch.disable');\n    }\n  }\n  /**\n   * Toggles both Network and Fetch domains.\n   */\n  async toggleNetworkIfNeeded() {\n    const enabled = this.isSubscribedTo(chromium_bidi_js_1.BiDiModule.Network);\n    if (enabled === this.#networkDomainEnabled) {\n      return;\n    }\n    this.#networkDomainEnabled = enabled;\n    try {\n      await Promise.all([this.#cdpClient.sendCommand(enabled ? 'Network.enable' : 'Network.disable'), this.toggleFetchIfNeeded()]);\n    } catch (err) {\n      this.#networkDomainEnabled = !enabled;\n    }\n  }\n  #setEventListeners() {\n    this.#cdpClient.on('*', (event, params) => {\n      // We may encounter uses for EventEmitter other than CDP events,\n      // which we want to skip.\n      if (typeof event !== 'string') {\n        return;\n      }\n      this.#eventManager.registerEvent({\n        type: 'event',\n        method: `cdp.${event}`,\n        params: {\n          event,\n          params,\n          session: this.cdpSessionId\n        }\n      }, this.id);\n    });\n  }\n  /**\n   * All the ProxyChannels from all the preload scripts of the given\n   * BrowsingContext.\n   */\n  getChannels() {\n    return this.#preloadScriptStorage.find().flatMap(script => script.channels);\n  }\n  /** Loads all top-level preload scripts. */\n  async #initAndEvaluatePreloadScripts() {\n    await Promise.all(this.#preloadScriptStorage.find({\n      // Needed for OOPIF\n      targetId: this.topLevelId,\n      global: true\n    }).map(script => {\n      return script.initInTarget(this, true);\n    }));\n  }\n  get topLevelId() {\n    return this.#browsingContextStorage.findTopLevelContextId(this.id) ?? this.id;\n  }\n  isSubscribedTo(moduleOrEvent) {\n    return this.#eventManager.subscriptionManager.isSubscribedTo(moduleOrEvent, this.topLevelId);\n  }\n}\nexports.CdpTarget = CdpTarget;","map":{"version":3,"names":["chromium_bidi_js_1","require","Deferred_js_1","LogManager_js_1","CdpTarget","id","cdpClient","browserCdpClient","eventManager","preloadScriptStorage","browsingContextStorage","networkStorage","unblocked","Deferred","acceptInsecureCerts","networkDomainEnabled","fetchDomainStages","request","response","auth","create","targetId","realmStorage","logger","cdpTarget","LogManager","setEventListeners","unblock","constructor","cdpSessionId","sessionId","#unblock","Promise","all","sendCommand","enabled","ignore","toggleNetworkIfNeeded","autoAttach","waitForDebuggerOnStart","flatten","initAndEvaluatePreloadScripts","error","isCloseError","resolve","kind","value","undefined","toggleFetchIfNeeded","stages","getInterceptionStages","topLevelId","patterns","push","urlPattern","requestStage","length","handleAuthRequests","isSubscribedTo","BiDiModule","Network","err","#setEventListeners","on","event","params","registerEvent","type","method","session","getChannels","find","flatMap","script","channels","#initAndEvaluatePreloadScripts","global","map","initInTarget","findTopLevelContextId","moduleOrEvent","subscriptionManager","exports"],"sources":["../../../../../src/bidiMapper/modules/cdp/CdpTarget.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}