{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.BrowsingContextProcessor = void 0;\nconst protocol_js_1 = require(\"../../../protocol/protocol.js\");\nclass BrowsingContextProcessor {\n  #browserCdpClient;\n  #browsingContextStorage;\n  constructor(browserCdpClient, browsingContextStorage) {\n    this.#browserCdpClient = browserCdpClient;\n    this.#browsingContextStorage = browsingContextStorage;\n  }\n  getTree(params) {\n    const resultContexts = params.root === undefined ? this.#browsingContextStorage.getTopLevelContexts() : [this.#browsingContextStorage.getContext(params.root)];\n    return {\n      contexts: resultContexts.map(c => c.serializeToBidiValue(params.maxDepth ?? Number.MAX_VALUE))\n    };\n  }\n  async create(params) {\n    let referenceContext;\n    let userContext = 'default';\n    if (params.referenceContext !== undefined) {\n      referenceContext = this.#browsingContextStorage.getContext(params.referenceContext);\n      if (!referenceContext.isTopLevelContext()) {\n        throw new protocol_js_1.InvalidArgumentException(`referenceContext should be a top-level context`);\n      }\n      userContext = referenceContext.userContext;\n    }\n    if (params.userContext !== undefined) {\n      userContext = params.userContext;\n    }\n    let newWindow = false;\n    switch (params.type) {\n      case \"tab\" /* BrowsingContext.CreateType.Tab */:\n        newWindow = false;\n        break;\n      case \"window\" /* BrowsingContext.CreateType.Window */:\n        newWindow = true;\n        break;\n    }\n    if (userContext !== 'default') {\n      const existingContexts = this.#browsingContextStorage.getAllContexts().filter(context => context.userContext === userContext);\n      if (!existingContexts.length) {\n        // If there are no contexts in the given user context, we need to set\n        // newWindow to true as newWindow=false will be rejected.\n        newWindow = true;\n      }\n    }\n    let result;\n    try {\n      result = await this.#browserCdpClient.sendCommand('Target.createTarget', {\n        url: 'about:blank',\n        newWindow,\n        browserContextId: userContext === 'default' ? undefined : userContext\n      });\n    } catch (err) {\n      if (\n      // See https://source.chromium.org/chromium/chromium/src/+/main:chrome/browser/devtools/protocol/target_handler.cc;l=90;drc=e80392ac11e48a691f4309964cab83a3a59e01c8\n      err.message.startsWith('Failed to find browser context with id') ||\n      // See https://source.chromium.org/chromium/chromium/src/+/main:headless/lib/browser/protocol/target_handler.cc;l=49;drc=e80392ac11e48a691f4309964cab83a3a59e01c8\n      err.message === 'browserContextId') {\n        throw new protocol_js_1.NoSuchUserContextException(`The context ${userContext} was not found`);\n      }\n      throw err;\n    }\n    // Wait for the new tab to be loaded to avoid race conditions in the\n    // `browsingContext` events, when the `browsingContext.domContentLoaded` and\n    // `browsingContext.load` events from the initial `about:blank` navigation\n    // are emitted after the next navigation is started.\n    // Details: https://github.com/web-platform-tests/wpt/issues/35846\n    const contextId = result.targetId;\n    const context = this.#browsingContextStorage.getContext(contextId);\n    await context.lifecycleLoaded();\n    return {\n      context: context.id\n    };\n  }\n  navigate(params) {\n    const context = this.#browsingContextStorage.getContext(params.context);\n    return context.navigate(params.url, params.wait ?? \"none\" /* BrowsingContext.ReadinessState.None */);\n  }\n  reload(params) {\n    const context = this.#browsingContextStorage.getContext(params.context);\n    return context.reload(params.ignoreCache ?? false, params.wait ?? \"none\" /* BrowsingContext.ReadinessState.None */);\n  }\n  async activate(params) {\n    const context = this.#browsingContextStorage.getContext(params.context);\n    if (!context.isTopLevelContext()) {\n      throw new protocol_js_1.InvalidArgumentException('Activation is only supported on the top-level context');\n    }\n    await context.activate();\n    return {};\n  }\n  async captureScreenshot(params) {\n    const context = this.#browsingContextStorage.getContext(params.context);\n    return await context.captureScreenshot(params);\n  }\n  async print(params) {\n    const context = this.#browsingContextStorage.getContext(params.context);\n    return await context.print(params);\n  }\n  async setViewport(params) {\n    const context = this.#browsingContextStorage.getContext(params.context);\n    if (!context.isTopLevelContext()) {\n      throw new protocol_js_1.InvalidArgumentException('Emulating viewport is only supported on the top-level context');\n    }\n    await context.setViewport(params.viewport, params.devicePixelRatio);\n    return {};\n  }\n  async traverseHistory(params) {\n    const context = this.#browsingContextStorage.getContext(params.context);\n    if (!context) {\n      throw new protocol_js_1.InvalidArgumentException(`No browsing context with id ${params.context}`);\n    }\n    await context.traverseHistory(params.delta);\n    return {};\n  }\n  async handleUserPrompt(params) {\n    const context = this.#browsingContextStorage.getContext(params.context);\n    try {\n      await context.handleUserPrompt(params);\n    } catch (error) {\n      // Heuristically determine the error\n      // https://source.chromium.org/chromium/chromium/src/+/main:content/browser/devtools/protocol/page_handler.cc;l=1085?q=%22No%20dialog%20is%20showing%22&ss=chromium\n      if (error.message?.includes('No dialog is showing')) {\n        throw new protocol_js_1.NoSuchAlertException('No dialog is showing');\n      }\n      throw error;\n    }\n    return {};\n  }\n  async close(params) {\n    const context = this.#browsingContextStorage.getContext(params.context);\n    if (!context.isTopLevelContext()) {\n      throw new protocol_js_1.InvalidArgumentException(`Non top-level browsing context ${context.id} cannot be closed.`);\n    }\n    try {\n      const detachedFromTargetPromise = new Promise(resolve => {\n        const onContextDestroyed = event => {\n          if (event.targetId === params.context) {\n            this.#browserCdpClient.off('Target.detachedFromTarget', onContextDestroyed);\n            resolve();\n          }\n        };\n        this.#browserCdpClient.on('Target.detachedFromTarget', onContextDestroyed);\n      });\n      if (params.promptUnload) {\n        await context.close();\n      } else {\n        await this.#browserCdpClient.sendCommand('Target.closeTarget', {\n          targetId: params.context\n        });\n      }\n      // Sometimes CDP command finishes before `detachedFromTarget` event,\n      // sometimes after. Wait for the CDP command to be finished, and then wait\n      // for `detachedFromTarget` if it hasn't emitted.\n      await detachedFromTargetPromise;\n    } catch (error) {\n      // Swallow error that arise from the page being destroyed\n      // Example is navigating to faulty SSL certificate\n      if (!(error.code === -32000 /* CdpErrorConstants.GENERIC_ERROR */ && error.message === 'Not attached to an active page')) {\n        throw error;\n      }\n    }\n    return {};\n  }\n  async locateNodes(params) {\n    const context = this.#browsingContextStorage.getContext(params.context);\n    return await context.locateNodes(params);\n  }\n}\nexports.BrowsingContextProcessor = BrowsingContextProcessor;","map":{"version":3,"names":["protocol_js_1","require","BrowsingContextProcessor","browserCdpClient","browsingContextStorage","constructor","getTree","params","resultContexts","root","undefined","getTopLevelContexts","getContext","contexts","map","c","serializeToBidiValue","maxDepth","Number","MAX_VALUE","create","referenceContext","userContext","isTopLevelContext","InvalidArgumentException","newWindow","type","existingContexts","getAllContexts","filter","context","length","result","sendCommand","url","browserContextId","err","message","startsWith","NoSuchUserContextException","contextId","targetId","lifecycleLoaded","id","navigate","wait","reload","ignoreCache","activate","captureScreenshot","print","setViewport","viewport","devicePixelRatio","traverseHistory","delta","handleUserPrompt","error","includes","NoSuchAlertException","close","detachedFromTargetPromise","Promise","resolve","onContextDestroyed","event","off","on","promptUnload","code","locateNodes","exports"],"sources":["../../../../../src/bidiMapper/modules/context/BrowsingContextProcessor.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}